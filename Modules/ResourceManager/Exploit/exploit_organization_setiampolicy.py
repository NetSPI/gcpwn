from Modules.ResourceManager.utils.util_helpers import *

# Entrypoint
def run_module(user_args, session, first_run = False, last_run = False, output_format = ["table"]):
    
    # Set up Argparser to handle flag arguments
    parser = argparse.ArgumentParser(description="Set the IAM Policy for a Given Organization", allow_abbrev=False)
    
    # Debug/non-module specific
    parser.add_argument("-v","--debug",action="store_true",required=False,help="Get verbose data during the module run")
    
    parser.add_argument("--organization-name", type=str, required=False,  help="Folder system name (not user-assigned common name) ex: folders/ID")
    
    parser.add_argument("--role", type=str, required=False,  help="Role to add (format - roles/<role_name>)")
    parser.add_argument("--member", type=str, required=False,  help="User to add to the policy at the given role (format - user:<email> / serviceAccount:<email>)")
    parser.add_argument("--overwrite", action="store_true", required=False,  help="If the current policy cannot be gathered and appended to, rewrite entire IAM policy with just your member")

    args = parser.parse_args(user_args)

    debug = args.debug

    organization_client = resourcemanager_v3.OrganizationsClient(credentials=session.credentials)

    organization_name, member, role = None, None, None

    if args.organization_name:
        organization_name = args.organization_name
        status, incorrect_input = UtilityTools.validate_input_format(organization_name, 2)
        if status != 0: 
            print(f"{UtilityTools.RED}[X] Value \"{incorrect_input}\" is incorrect. Must be 'organizations/[organization_number]' Please try again...{UtilityTools.RESET}")
            return -1

    if args.member:

        member = args.member
        status, incorrect_input = UtilityTools.validate_user_format(member)
        if status != 0: 
            print(f"{UtilityTools.RED}[X] Value \"{incorrect_input}\" is incorrect. Must be 'user:[email]' or 'serviceAccount:[email]' Please try again...{UtilityTools.RESET}")
            return -1

    if args.role:
        role = args.role


    if not organization_name:
        rows_returned = session.get_data("abstract-tree-hierarchy", columns = ["name", "display_name"], conditions = "type=\"org\"")
        if len(rows_returned) == 0:
            print("[X] No organizations found. Try rerunning module with with specified resource via --organization-name ")
            return -1

        for row in rows_returned:
            name, display_name = row["name"], row["display_name"]
            row["display_to_user"] = f"{name} (aka \"{display_name}\")"

        # Return dictionary corresponding to user choice
        organization_dict = session.choice_selector(rows_returned,"Choose an existing organization from below to edit the corresponding policy:", fields=["display_to_user"])
        
        if not organization_dict:
            print("[X] Exiting the current module...")
            return -1   

        # Project ID could be "Unknown"
        organization_name = organization_dict["name"]


    if not member:
        member = session.choose_member()
        if not member:
            print("Exiting...")
            return -1
    
    if not role:
        default_role = "roles/resourcemanager.organizationAdmin"
        organization_roles_sample = [
            "roles/owner",
            "roles/editor",
            "roles/viewer",
            f"{default_role} (Default)",
            "roles/resourcemanager.organizationViewer",
            "roles/orgpolicy.policyAdmin",
            "roles/browser"
            "Exit"
        ]
        role = session.choose_role(organization_roles_sample, chosen_role = args.role, default_role = default_role)
        if not role:
            return -1

    if debug:
        print(f"[DEBUG] Proceeding with:\n  Organization:{organization_name}\n")
        print(f"[DEBUG] Proceeding with member: {member}")
        print(f"[DEBUG] Proceeding with role: {role}")

    print(f"[*] Binding Member {member} on {organization_name} to role {role}")

    action_dict = {}

    status = add_organization_iam_member(organization_client, organization_name, member, action_dict, brute = args.overwrite, role = role, debug=debug)

    if status:
        if status == -1:
            print(f"{UtilityTools.RED}{UtilityTools.BOLD}[X] Failed to add {member} to policy of organization {organization_name}{UtilityTools.RESET}")
        else:
            print(f"{UtilityTools.GREEN}{UtilityTools.BOLD}[*] Successfully added {member} to the policy of organization {organization_name}{UtilityTools.RESET}")
   
    if action_dict: session.insert_actions(action_dict) 